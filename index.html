<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Stereo Image Generator</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --secondary: #3f37c9;
      --text: #2b2d42;
      --text-light: #8d99ae;
      --border: #e2e8f0;
      --bg: #f8fafc;
      --bg-light: #ffffff;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --radius: 12px;
      --radius-sm: 8px;
      --transition: all 0.2s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      line-height: 1.5;
      color: var(--text);
      background-color: var(--bg);
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
      touch-action: manipulation;
      -webkit-font-smoothing: antialiased;
    }

    .app-container {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    header {
      text-align: center;
      margin-bottom: 8px;
    }

    h1 {
      font-size: 28px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 4px;
    }

    .subtitle {
      color: var(--text-light);
      font-size: 16px;
      max-width: 600px;
      margin: 0 auto;
    }

    .card {
      background-color: var(--bg-light);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-title svg {
      width: 20px;
      height: 20px;
    }

    .upload-section {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 16px;
    }

    .btn {
      padding: 12px 20px;
      cursor: pointer;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 15px;
      font-weight: 500;
      flex: 1 1 auto;
      min-width: 140px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: var(--transition);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .btn:hover {
      background-color: var(--primary-dark);
      transform: translateY(-1px);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn:disabled {
      background-color: #e2e8f0;
      color: #94a3b8;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background-color: white;
      color: var(--primary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background-color: #f8fafc;
      border-color: #cbd5e1;
    }

    .btn-icon {
      width: 18px;
      height: 18px;
    }

    .canvas-container {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      width: 100%;
      overflow-x: auto;
      padding-bottom: 10px;
    }

    .canvas-wrapper {
      flex: 0 0 calc(50% - 8px);
      min-width: 0;
    }

    .canvas-label {
      font-weight: 600;
      font-size: 16px;
      color: var(--text);
      margin-bottom: 5px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      white-space: nowrap;
    }

    canvas {
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      width: 100%;
      max-width: 100%;
      background: #f8f8f8;
      background-image: linear-gradient(45deg, #e5e7eb 25%, transparent 25%, transparent 75%, #e5e7eb 75%),
                        linear-gradient(45deg, #e5e7eb 25%, transparent 25%, transparent 75%, #e5e7eb 75%);
      background-size: 20px 20px;
      background-position: 0 0, 10px 10px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
      aspect-ratio: 3/4; /* Portrait orientation */
    }

    #cameraPreview {
      display: none;
      width: 100%;
      max-height: 50vh;
      background: black;
      margin: 12px 0;
      border-radius: var(--radius-sm);
      aspect-ratio: 3/4; /* Portrait orientation */
    }

    .camera-options {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      width: 100%;
    }

    .status {
      color: var(--text-light);
      font-size: 14px;
      text-align: center;
      margin-top: 8px;
    }

    .controls-section {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 16px;
    }

    .quality-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-bottom: 16px;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .control-group label {
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
    }

    .control-group select {
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      font-size: 14px;
      background-color: white;
      transition: var(--transition);
    }

    .control-group select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2);
    }

    .result-wrapper {
      width: 100%;
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    #resultCanvas {
      max-width: 100%;
      max-height: 70vh;
      width: auto;
      height: auto;
      aspect-ratio: var(--result-aspect-ratio, 4/3); /* Default to landscape */
    }

    .loading {
      display: none;
      color: var(--primary);
      margin: 12px 0;
      text-align: center;
      font-size: 14px;
    }

    @media (max-width: 768px) {
      body {
        padding: 16px;
      }
      
      .card {
        padding: 20px;
      }
      
      .btn {
        padding: 12px 16px;
        font-size: 14px;
      }
      
      .canvas-wrapper {
        flex: 0 0 calc(50% - 8px);
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 24px;
      }
      
      .subtitle {
        font-size: 14px;
      }
      
      .card {
        padding: 16px;
      }
      
      .section-title {
        font-size: 16px;
      }
      
      .btn {
        min-width: 100%;
      }
      
      .quality-controls {
        flex-direction: column;
        gap: 12px;
      }
      
      .control-group {
        width: 100%;
      }
      
      .control-group select {
        width: 100%;
      }
      
      .camera-options {
        flex-direction: column;
      }
      
      .camera-options .btn {
        width: 100%;
      }
      
      .canvas-container {
        gap: 8px;
      }
      
      .canvas-wrapper {
        flex: 0 0 calc(50% - 4px);
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <header>
      <h1>Stereo Image Generator</h1>
      <p class="subtitle">Create side-by-side stereo images or red-cyan anaglyph 3D images from your photos</p>
    </header>
    
    <div class="card">
      <h2 class="section-title">
        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
        </svg>
        Image Sources
      </h2>
      
      <div class="upload-section">
        <button id="uploadLeft" class="btn">
          <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
          </svg>
          Upload Left
        </button>
        <button id="uploadRight" class="btn">
          <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
          </svg>
          Upload Right
        </button>
        <button id="takePhoto" class="btn btn-secondary">
          <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
          Take Photo
        </button>
      </div>
      
      <div class="camera-options">
        <button id="cameraSwitchBtn" class="btn btn-secondary">
          <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
          </svg>
          Switch Camera
        </button>
        <button id="photoCaptureBtn" class="btn">
          <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
          Capture Left
        </button>
      </div>
      
      <video id="cameraPreview" autoplay playsinline></video>
      <p id="cameraStatus" class="status">Camera not active</p>
      
      <div class="quality-controls">
        <div class="control-group">
          <label for="outputQuality">Output Quality:</label>
          <select id="outputQuality">
            <option value="1.0">Maximum (PNG)</option>
            <option value="0.9">High (WebP)</option>
            <option value="0.8">Good (JPEG)</option>
            <option value="0.6">Medium (JPEG)</option>
          </select>
        </div>
        
        <div class="control-group">
          <label for="outputSize">Output Size:</label>
          <select id="outputSize">
            <option value="original">Original</option>
            <option value="1080p">1080p</option>
            <option value="720p">720p</option>
            <option value="custom">Custom</option>
          </select>
        </div>
      </div>
      
      <div class="canvas-container">
        <div class="canvas-wrapper">
          <p class="canvas-label">
            <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            </svg>
            Left Image
          </p>
          <canvas id="leftCanvas"></canvas>
        </div>
        <div class="canvas-wrapper">
          <p class="canvas-label">
            <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            </svg>
            Right Image
          </p>
          <canvas id="rightCanvas"></canvas>
        </div>
      </div>
    </div>
    
    <div class="card">
      <h2 class="section-title">
        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"></path>
        </svg>
        Processing
      </h2>
      
      <div class="controls-section">
        <button id="autoAlign" class="btn btn-secondary" disabled>
          <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
          </svg>
          Auto-Align
        </button>
        <button id="generateSideBySide" class="btn" disabled>
          <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"></path>
          </svg>
          Side-by-Side
        </button>
        <button id="generateAnaglyph" class="btn" disabled>
          <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
          </svg>
          Red/Cyan 3D
        </button>
        <button id="saveResult" class="btn" disabled>
          <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
          </svg>
          Save Result
        </button>
      </div>
      
      <div class="result-wrapper">
        <h2 class="section-title">
          <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
          </svg>
          Result
        </h2>
        <canvas id="resultCanvas"></canvas>
      </div>
    </div>
  </div>

  <script>
    // DOM elements
    const uploadLeftBtn = document.getElementById('uploadLeft');
    const uploadRightBtn = document.getElementById('uploadRight');
    const takePhotoBtn = document.getElementById('takePhoto');
    const cameraSwitchBtn = document.getElementById('cameraSwitchBtn');
    const photoCaptureBtn = document.getElementById('photoCaptureBtn');
    const cameraPreview = document.getElementById('cameraPreview');
    const cameraStatus = document.getElementById('cameraStatus');
    const autoAlignBtn = document.getElementById('autoAlign');
    const generateSideBySideBtn = document.getElementById('generateSideBySide');
    const generateAnaglyphBtn = document.getElementById('generateAnaglyph');
    const saveResultBtn = document.getElementById('saveResult');
    const outputQualitySelect = document.getElementById('outputQuality');
    const outputSizeSelect = document.getElementById('outputSize');
    const resultCanvas = document.getElementById('resultCanvas');

    const leftCanvas = document.getElementById('leftCanvas');
    const rightCanvas = document.getElementById('rightCanvas');

    const leftCtx = leftCanvas.getContext('2d', { willReadFrequently: true });
    const rightCtx = rightCanvas.getContext('2d', { willReadFrequently: true });
    const resultCtx = resultCanvas.getContext('2d', { willReadFrequently: true });

    // State variables
    let leftImage = null;
    let rightImage = null;
    let currentCameraSide = 'left';
    let currentStream = null;
    let useFrontCamera = false;
    let leftCanvasData = null;
    let rightCanvasData = null;
    let resultCanvasData = null;

    // Initialize canvas sizes with proper aspect ratio and high quality
    function initCanvases() {
      // For left and right canvases, use portrait orientation
      const portraitHeight = Math.min(window.innerHeight * 0.3, 300);
      const portraitWidth = portraitHeight * 0.75;
      
      if (!leftImage) {
        leftCanvas.width = portraitWidth;
        leftCanvas.height = portraitHeight;
      }
      
      if (!rightImage) {
        rightCanvas.width = portraitWidth;
        rightCanvas.height = portraitHeight;
      }
      
      // For result canvas, make it large enough for high-quality output
      // Default to landscape (will be adjusted when generating)
      resultCanvas.width = Math.min(window.innerWidth * 0.95, 1920);
      resultCanvas.height = Math.min(window.innerHeight * 0.7, 1080);
      
      // Restore content if available
      if (leftCanvasData) restoreCanvas(leftCanvas, leftCanvasData);
      if (rightCanvasData) restoreCanvas(rightCanvas, rightCanvasData);
      if (resultCanvasData) restoreCanvas(resultCanvas, resultCanvasData);
    }

    // Function to restore canvas content with high quality
    function restoreCanvas(canvas, dataUrl) {
      if (!dataUrl) return;
      
      const img = new Image();
      img.onload = function() {
        const ctx = canvas.getContext('2d');
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Use high-quality drawing
        ctx.imageSmoothingEnabled = true;
        ctx.drawImage(img, 0, 0);
        
        // Update the corresponding image reference
        if (canvas.id === 'leftCanvas') {
          leftImage = img;
        } else if (canvas.id === 'rightCanvas') {
          rightImage = img;
        }
        updateUI();
      };
      img.src = dataUrl;
    }

    // Upload images with quality preservation
    function handleImageUpload(canvas, ctx, e) {
      const file = e.target.files[0];
      if (!file) return;

      const img = new Image();
      img.onload = () => {
        // Set canvas to exact image dimensions
        canvas.width = img.width;
        canvas.height = img.height;
        
        // Draw the image at full resolution
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.imageSmoothingEnabled = true;
        ctx.drawImage(img, 0, 0);
        
        // Save the canvas data at high quality
        const dataUrl = getCanvasDataUrl(canvas);
        if (canvas.id === 'leftCanvas') {
          leftImage = img;
          leftCanvasData = dataUrl;
        } else {
          rightImage = img;
          rightCanvasData = dataUrl;
        }
        updateUI();
      };
      img.src = URL.createObjectURL(file);
    }

    // Helper function to get canvas data URL with selected quality
    function getCanvasDataUrl(canvas) {
      const quality = parseFloat(outputQualitySelect.value);
      const format = quality === 1.0 ? 'image/png' : 'image/jpeg';
      return canvas.toDataURL(format, quality);
    }

    // Helper function to resize image with high quality
    function resizeImage(image, targetWidth, targetHeight) {
      const canvas = document.createElement('canvas');
      canvas.width = targetWidth;
      canvas.height = targetHeight;
      const ctx = canvas.getContext('2d');
      ctx.imageSmoothingEnabled = true;
      ctx.drawImage(image, 0, 0, targetWidth, targetHeight);
      return canvas;
    }

    uploadLeftBtn.addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = (e) => handleImageUpload(leftCanvas, leftCtx, e);
      input.click();
    });

    uploadRightBtn.addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = (e) => handleImageUpload(rightCanvas, rightCtx, e);
      input.click();
    });

    // Camera functions with quality improvements
    async function startCamera(facingMode = 'environment') {
      try {
        if (currentStream) {
          currentStream.getTracks().forEach(track => track.stop());
        }

        const constraints = {
          video: { 
            facingMode: facingMode,
            width: { ideal: 1080 },
            height: { ideal: 1440 } // Prefer portrait orientation
          }
        };

        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        cameraPreview.srcObject = stream;
        cameraPreview.style.display = 'block';
        photoCaptureBtn.style.display = 'inline-block';
        cameraSwitchBtn.style.display = 'inline-block';
        takePhotoBtn.style.display = 'none';
        currentStream = stream;
        cameraStatus.textContent = `Camera active (${useFrontCamera ? 'Front' : 'Rear'})`;

        photoCaptureBtn.textContent = `Capture ${currentCameraSide === 'left' ? 'Left' : 'Right'}`;
      } catch (err) {
        cameraStatus.textContent = `Camera error: ${err.message}`;
        console.error('Camera error:', err);
      }
    }

    takePhotoBtn.addEventListener('click', () => {
      startCamera(useFrontCamera ? 'user' : 'environment');
    });

    cameraSwitchBtn.addEventListener('click', () => {
      useFrontCamera = !useFrontCamera;
      startCamera(useFrontCamera ? 'user' : 'environment');
    });

    photoCaptureBtn.addEventListener('click', () => {
      if (!currentStream) return;
      
      const canvas = currentCameraSide === 'left' ? leftCanvas : rightCanvas;
      const ctx = currentCameraSide === 'left' ? leftCtx : rightCtx;

      // Get the actual video dimensions
      const videoWidth = cameraPreview.videoWidth;
      const videoHeight = cameraPreview.videoHeight;
      
      // Set canvas to match camera resolution (portrait)
      canvas.width = videoWidth;
      canvas.height = videoHeight;
      
      // Draw with high quality
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.imageSmoothingEnabled = true;
      ctx.drawImage(cameraPreview, 0, 0, canvas.width, canvas.height);

      // Save at high quality
      const dataUrl = getCanvasDataUrl(canvas);
      if (currentCameraSide === 'left') {
        leftCanvasData = dataUrl;
        leftImage = new Image();
        leftImage.src = dataUrl;
        currentCameraSide = 'right';
        photoCaptureBtn.textContent = 'Capture Right';
      } else {
        rightCanvasData = dataUrl;
        rightImage = new Image();
        rightImage.src = dataUrl;
        stopCamera();
        currentCameraSide = 'left';
      }
      
      updateUI();
    });

    function stopCamera() {
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
        currentStream = null;
      }
      cameraPreview.style.display = 'none';
      photoCaptureBtn.style.display = 'none';
      cameraSwitchBtn.style.display = 'none';
      takePhotoBtn.style.display = 'inline-block';
      cameraStatus.textContent = 'Camera not active';
    }

    // High-quality auto-align
    autoAlignBtn.addEventListener('click', () => {
      if (!leftImage || !rightImage) {
        alert('Please upload both images first!');
        return;
      }

      // Use the larger dimensions as target
      const targetWidth = Math.max(leftImage.width, rightImage.width);
      const targetHeight = Math.max(leftImage.height, rightImage.height);

      // Resize canvases to target dimensions
      leftCanvas.width = rightCanvas.width = targetWidth;
      leftCanvas.height = rightCanvas.height = targetHeight;

      // Draw images centered and properly scaled at high quality
      leftCtx.clearRect(0, 0, targetWidth, targetHeight);
      rightCtx.clearRect(0, 0, targetWidth, targetHeight);
      
      leftCtx.imageSmoothingEnabled = true;
      rightCtx.imageSmoothingEnabled = true;
      
      // Calculate scaling to fit while maintaining aspect ratio
      const leftScale = Math.min(
        targetWidth / leftImage.width,
        targetHeight / leftImage.height
      );
      const rightScale = Math.min(
        targetWidth / rightImage.width,
        targetHeight / rightImage.height
      );
      
      const leftNewWidth = leftImage.width * leftScale;
      const leftNewHeight = leftImage.height * leftScale;
      const rightNewWidth = rightImage.width * rightScale;
      const rightNewHeight = rightImage.height * rightScale;
      
      // Center the images
      leftCtx.drawImage(
        leftImage,
        (targetWidth - leftNewWidth) / 2,
        (targetHeight - leftNewHeight) / 2,
        leftNewWidth,
        leftNewHeight
      );
      
      rightCtx.drawImage(
        rightImage,
        (targetWidth - rightNewWidth) / 2,
        (targetHeight - rightNewHeight) / 2,
        rightNewWidth,
        rightNewHeight
      );
      
      // Update image references and save canvas data at high quality
      leftCanvasData = getCanvasDataUrl(leftCanvas);
      rightCanvasData = getCanvasDataUrl(rightCanvas);
      leftImage = new Image();
      leftImage.src = leftCanvasData;
      rightImage = new Image();
      rightImage.src = rightCanvasData;
    });

    // High-quality side-by-side generation
    generateSideBySideBtn.addEventListener('click', () => {
      if (!leftImage || !rightImage) {
        alert('Please upload both images first!');
        return;
      }

      // Set landscape aspect ratio for result
      resultCanvas.style.setProperty('--result-aspect-ratio', '4/3');

      // Determine output size based on selection
      let outputWidth = leftImage.width + rightImage.width;
      let outputHeight = Math.max(leftImage.height, rightImage.height);
      
      const sizeOption = outputSizeSelect.value;
      if (sizeOption !== 'original') {
        const targetHeight = sizeOption === '1080p' ? 1080 : 720;
        const scale = targetHeight / outputHeight;
        outputWidth = Math.round(outputWidth * scale);
        outputHeight = targetHeight;
      }

      // Create temporary canvases at target resolution
      const tempLeftCanvas = resizeImage(
        leftImage,
        Math.round(leftImage.width * (outputHeight / leftImage.height)),
        outputHeight
      );
      
      const tempRightCanvas = resizeImage(
        rightImage,
        Math.round(rightImage.width * (outputHeight / rightImage.height)),
        outputHeight
      );
      
      // Set result canvas dimensions
      resultCanvas.width = tempLeftCanvas.width + tempRightCanvas.width;
      resultCanvas.height = outputHeight;
      
      // Draw at full resolution with high quality
      resultCtx.clearRect(0, 0, resultCanvas.width, resultCanvas.height);
      resultCtx.imageSmoothingEnabled = true;
      resultCtx.drawImage(tempLeftCanvas, 0, 0);
      resultCtx.drawImage(tempRightCanvas, tempLeftCanvas.width, 0);
      
      // Save at highest quality
      resultCanvasData = getCanvasDataUrl(resultCanvas);
      delete resultCanvas.dataset.gifUrl;
    });

    // High-quality anaglyph generation
    generateAnaglyphBtn.addEventListener('click', () => {
      if (!leftImage || !rightImage) {
        alert('Please upload both images first!');
        return;
      }

      // Set portrait aspect ratio for result
      resultCanvas.style.setProperty('--result-aspect-ratio', '3/4');

      // Determine output size based on selection
      let width = Math.max(leftImage.width, rightImage.width);
      let height = Math.max(leftImage.height, rightImage.height);
      
      const sizeOption = outputSizeSelect.value;
      if (sizeOption !== 'original') {
        const targetHeight = sizeOption === '1080p' ? 1440 : 960; // Taller for portrait
        const scale = targetHeight / height;
        width = Math.round(width * scale);
        height = targetHeight;
      }

      // Create temporary canvases at target resolution
      const tempLeftCanvas = document.createElement('canvas');
      tempLeftCanvas.width = width;
      tempLeftCanvas.height = height;
      const tempLeftCtx = tempLeftCanvas.getContext('2d');
      tempLeftCtx.imageSmoothingEnabled = true;
      
      // Scale and center left image
      const leftScale = Math.min(
        width / leftImage.width,
        height / leftImage.height
      );
      const leftNewWidth = leftImage.width * leftScale;
      const leftNewHeight = leftImage.height * leftScale;
      tempLeftCtx.drawImage(
        leftImage,
        (width - leftNewWidth) / 2,
        (height - leftNewHeight) / 2,
        leftNewWidth,
        leftNewHeight
      );

      const tempRightCanvas = document.createElement('canvas');
      tempRightCanvas.width = width;
      tempRightCanvas.height = height;
      const tempRightCtx = tempRightCanvas.getContext('2d');
      tempRightCtx.imageSmoothingEnabled = true;
      
      // Scale and center right image
      const rightScale = Math.min(
        width / rightImage.width,
        height / rightImage.height
      );
      const rightNewWidth = rightImage.width * rightScale;
      const rightNewHeight = rightImage.height * rightScale;
      tempRightCtx.drawImage(
        rightImage,
        (width - rightNewWidth) / 2,
        (height - rightNewHeight) / 2,
        rightNewWidth,
        rightNewHeight
      );

      // Set result canvas size
      resultCanvas.width = width;
      resultCanvas.height = height;
      resultCtx.clearRect(0, 0, width, height);

      // Create the anaglyph effect at full resolution
      const leftData = tempLeftCtx.getImageData(0, 0, width, height);
      const rightData = tempRightCtx.getImageData(0, 0, width, height);
      const resultData = resultCtx.createImageData(width, height);

      for (let i = 0; i < leftData.data.length; i += 4) {
        resultData.data[i] = leftData.data[i];         // Red from left
        resultData.data[i + 1] = rightData.data[i + 1]; // Green from right
        resultData.data[i + 2] = rightData.data[i + 2]; // Blue from right
        resultData.data[i + 3] = 255;                  // Alpha
      }

      resultCtx.putImageData(resultData, 0, 0);
      resultCanvasData = getCanvasDataUrl(resultCanvas);
      delete resultCanvas.dataset.gifUrl;
    });

    // High-quality save function
    saveResultBtn.addEventListener('click', () => {
      if (resultCanvas.width === 0 || resultCanvas.height === 0) {
        alert('No result to save! Generate an image first.');
        return;
      }

      const link = document.createElement('a');
      link.download = 'stereo-image.' + (outputQualitySelect.value === '1.0' ? 'png' : 'jpg');
      link.href = resultCanvasData || getCanvasDataUrl(resultCanvas);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    // Helper function to update UI state
    function updateUI() {
      const hasBothImages = leftImage && rightImage;
      autoAlignBtn.disabled = !hasBothImages;
      generateSideBySideBtn.disabled = !hasBothImages;
      generateAnaglyphBtn.disabled = !hasBothImages;
      saveResultBtn.disabled = resultCanvas.width === 0;
      
      // Update photo capture button text
      if (photoCaptureBtn.style.display !== 'none') {
        photoCaptureBtn.textContent = `Capture ${currentCameraSide === 'left' ? 'Left' : 'Right'}`;
      }
    }

    // Initialize
    initCanvases();
    updateUI();

    // Add visibility change handler to restore canvases if needed
    document.addEventListener('visibilitychange', function() {
      if (!document.hidden) {
        if (leftCanvasData) restoreCanvas(leftCanvas, leftCanvasData);
        if (rightCanvasData) restoreCanvas(rightCanvas, rightCanvasData);
        if (resultCanvasData) restoreCanvas(resultCanvas, resultCanvasData);
      }
    });

    // Handle window resize
    window.addEventListener('resize', function() {
      initCanvases();
    });
  </script>
</body>
</html>
